
<meta id='data' data-pod-uuid="{{notebook.pod_uuid}}"/>

<div class='nb'>
    {% set ready =  notebook.pod_status == 'Running'
                    and notebook.condition.status == 'True'
                    and notebook.condition.type == 'Ready'
    %}


        <div id="{{notebook.pod_uuid}}-visual-summary">
            <div class="spinner"></div>
        </div>

    <a
        target="_blank"
        class="nb-state-container"
        id="{{notebook.pod_uuid}}"
        href={{ notebook['url'] }}
    >
        <b>{{notebook.name}}</b>
        <span class="small">
                Pod Name: <b>{{notebook.pod_name}}</b>
            </span>
        <span class="small">Created on: <b id="{{notebook.pod_uuid}}-creation-date">{{notebook.creation_date}}</b></span>
        <span class="small">Reachable: <b id="{{notebook.pod_uuid}}-reach">N/A</b></span>
        <span class="small">
            Container:
            <b id="{{notebook.pod_uuid}}-container-status">
                {% if notebook.container_status.waiting %}
                    {{ notebook.container_status.waiting.reason }}
                {% elif notebook.container_status.running %}
                    Started @ {{ notebook.container_status.running.started_at }}
                {% elif notebook.container_status.terminated %}
                    Finished @ {{ notebook.container_status.running.finished_at }}
                {% else %}
                    Initializing
                {% endif %}
            </b>
        </span>
        <span class="small">
            Pod Condition:
            <b id="{{notebook.pod_uuid}}-condition">
                {% if notebook.condition is not defined %}
                    Initializing
                {% elif notebook.condition.status != "True" %}
                    {{"Waiting for " ~ notebook.condition.type}}
                {% else %}
                    {{notebook.condition.type}}
                {% endif %}
            </b>
        </span>
        <span class="small">
            Pod Status: <b id="{{notebook.pod_uuid}}-pod-status">{{notebook.pod_status}}</b>
        </span>


    </a>
    <form action='/notebook/delete' method='POST'>
        <button type='submit' class="material-icons nb-close">
            close
        </button>
    </form>
</div>

<script src="https://unpkg.com/unfetch/polyfill"></script>

<script>
    function checkReachabilityAndMark(podUUID) {
        el = document.getElementById(`${podUUID}-visual-summary`);

        if(el === null) {
            console.error(`${podUUID} not found on page`);
            return;
        }

        checkReachability(podUUID).then(() => {
            el.innerHTML = '<i class="material-icons reachable-icon">done</i>';
        }, () => {
            el.innerHTML = '<i class="material-icons unreachable-icon">block</i>';
        });
    }

    function checkReachability(podUUID) {
        const url = `/instance-ready/${podUUID}/`
        const el = document.getElementById(`${podUUID}-reach`);

        el.innerText = "Testing!";

        const promise = new Promise((resolve, reject) => {
            if(el === null) {
                reject("Job not found in this window")
                return;
            }

            const interval = setInterval(() => {
                fetch(url, {
                    method: 'HEAD'
                }).then((r) => {
                    if(r.status < 400) {
                        el.innerText = "Yep!";

                        clearInterval(interval);

                        resolve(true);
                        return;
                    }

                    if(r.status == 499) {
                        el.innerText = "Not yet!";
                        return;
                    }

                    if(r.status == 404) {
                        el.innerText = "Nope (not found)";

                        clearInterval(interval);
                        reject("Job endpoint not found on server");
                        return;
                    }
                });
            }, 500);
        })

        return promise;
    }
</script>

{% if ready %}
    <script>
        el = document.getElementById('data');
        const podUUID = el.dataset.podUuid;

        checkReachabilityAndMark(podUUID);
    </script>
{% else  %}
    <script>
        let protocol = location.protocol.replace("http", "ws")
        let sock = new WebSocket(protocol + location.host + "/wait");
        sock.onmessage = function (ev) {
            process(ev.data)
        }

        function process(json) {
            const data = JSON.parse(json);

            const notebooks = data.resource;

            for (let i = 0; i < notebooks.length; i++ ){
                const notebook = notebooks[i];

                if(!document.getElementById(`${notebook.pod_uuid}`)) {
                    continue;
                }

                const conditionElem = document.getElementById(`${notebook.pod_uuid}-condition`);

                if(!notebook.condition) {
                    conditionElem.innerText = "Initializing";
                } else if(notebook.condition.status !== "True") {
                    conditionElem.innerText = `Waiting for ${notebook.condition.type}`
                } else {
                    conditionElem.innerText = `${notebook.condition.type}`
                }

                document.getElementById(`${notebook.pod_uuid}-pod-status`).innerText = notebook.pod_status;

                const containerStatusElem = document.getElementById(`${notebook.pod_uuid}-container-status`)

                if(notebook.container_status.waiting) {
                    containerStatusElem.innerText = `${notebook.container_status.waiting.reason}`;
                } else if(notebook.container_status.running) {
                    containerStatusElem.innerText = `Started @ ${ notebook.container_status.running.started_at }`;
                } else if(notebook.container_status.terminated) {
                    containerStatusElem.innerText = `Finished @ ${ notebook.container_status.running.finished_at }`;
                }

                const ready = notebook.pod_status === 'Running' && notebook.condition.status === 'True' && notebook.condition.type === 'Ready';

                if(ready) {
                    checkReachabilityAndMark(notebook.pod_uuid));
                }
            }
        }
    </script>
{% endif %}