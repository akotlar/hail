function ri(t,e){return null==t&&(t=0),null==e&&(e=1),Math.floor(t+Math.random()*(e-t+1))}function getBrightness(t){return.299*t.r+.587*t.g+.114*t.b}class Viz{constructor(t={}){if(!THREE.WebGLRenderer)return void console.error("ThreeJS has not been loaded, or WebGL is unsupported");if(this.options=Object.assign({scale:1,scaleMobile:1,color:16727937,backgroundColor:268435455,points:10,maxDistance:20,spacing:15,showDots:!0},t),this.el=document.querySelector(this.options.el),!this.el)return void console.error(`Cannot find ${this.options.el}`);"absolute"==!this.el.style.position&&(this.el.style.position="absolute"),this.mouse={x:0,y:0,rawY:0,updated:!1,updatedCount:-1,ran:!1},this.highlightColor=new THREE.Color("purple"),this.cachedColor=new THREE.Color(0),this.options.color=new THREE.Color(this.options.color),this.options.backgroundColor=new THREE.Color(this.options.backgroundColor),this.diffColor=this.options.color.clone().sub(this.options.backgroundColor),this.colorB=getBrightness(new THREE.Color(this.options.color)),this.bgB=getBrightness(new THREE.Color(this.options.backgroundColor)),this.elOffset=this.el.offsetTop,this.elOnscreen=!1,this.isScrolling=!1,this.resizeTimeout=null,this.postInit=!1,this.points=[],this.animationLoop=this.animationLoop.bind(this),window.requestAnimationFrame(()=>{this.renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),this.el.appendChild(this.renderer.domElement)});let e=new IntersectionObserver(t=>{if(t.length>1&&console.warn("should be observing a single element, ignoring all but first"),this.elOnscreen=t[0].intersectionRatio>.6,this.interval=62.5,this.elOnscreen&&0==this.postInit)try{window.requestAnimationFrame(()=>{this.init(),this.postInit=!0,this.then=Date.now(),this.listen()}),window.requestAnimationFrame(()=>this.resize(!0)),window.requestAnimationFrame(()=>this.el.style.opacity="1"),window.requestAnimationFrame(this.animationLoop)}catch(t){return void(this.renderer&&this.renderer.domElement&&this.el.removeChild(this.renderer.domElement))}},{threshold:.6});window.requestAnimationFrame(()=>e.observe(this.renderer.domElement))}listen(){let t;this.elOffset=this.el.offsetTop,this.isScrolling=!1,this.resizeTimeout=null,window.addEventListener("resize",t=>this.resize(t)),window.addEventListener("scroll",()=>{this.isScrolling&&window.clearTimeout(this.isScrolling),this.isScrolling=setTimeout(()=>this.isScrolling=null,100)}),window.addEventListener("mousemove",e=>{t&&clearTimeout(t),t=setTimeout(()=>{this.onMouseMove2(e),t=null},this.mouse.dontshow?32:4)},!1),this.mouse.dontshow=!1;const e=document.getElementById("hero-content"),i=document.getElementById("hail-navbar");e.onmouseover=(()=>{t&&clearTimeout(t),this.mouse.updated=!1,this.mouse.updatedCount=0,this.mouse.dontshow=!0}),e.onmouseout=(()=>{t&&clearTimeout(t),this.mouse.updated=!0,this.mouse.updatedCount=0,this.mouse.dontshow=!1}),i.onmouseover=(()=>{t&&clearTimeout(t),this.mouse.updated=!1,this.mouse.updatedCount=0,this.mouse.dontshow=!0}),i.onmouseout=(()=>{t&&clearTimeout(t),this.mouse.updated=!0,this.mouse.updatedCount=0,this.mouse.dontshow=!1})}resize(t){this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>{this.camera&&(this.camera.aspect=this.el.offsetWidth/this.el.offsetHeight,"function"==typeof this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix()),this.renderer&&(this.renderer.setSize(this.el.offsetWidth,this.el.offsetHeight),this.renderer.setPixelRatio(window.devicePixelRatio)),this.resizeTimeout=null},this.postInit?100:0)}animationLoop(){const t=Date.now(),e=t-this.then;return!this.elOnscreen||this.isScrolling&&this.postInit||e>this.interval&&("function"==typeof this.onUpdate&&this.onUpdate(),this.scene&&this.camera&&(this.renderer.render(this.scene,this.camera),this.renderer.setClearColor(this.options.backgroundColor,this.options.backgroundAlpha)),this.fps&&this.fps.update&&this.fps.update(),"function"==typeof this.afterRender&&this.afterRender()),this.then=t-e%this.interval,this.req=window.setTimeout(this.animationLoop,this.elOnscreen?this.postInit?24:0:1e3)}onMouseMove2(t){if(!this.elOnscreen||this.mouse.dontshow)return;if(!this.mouse.ran)return void(this.mouse.ran=!0);this.rayCaster||(this.rayCaster=new THREE.Raycaster);const e=t.pageX,i=t.pageY-this.elOffset,s=e/this.el.offsetWidth*2-1,o=-i/this.el.offsetHeight*2+1;s===this.mouse.x&&o===this.mouse.y||(this.mouse.x=s,this.mouse.y=o,this.mouse.updated=!0,this.mouse.updatedCount=0,this.rayCaster.setFromCamera(new THREE.Vector2(this.mouse.x,this.mouse.y),this.camera))}genPoint(t,e,i){const s=new THREE.SphereGeometry(.25,12,12),o=new THREE.MeshLambertMaterial({color:this.options.color,transparent:!0,opacity:.2}),n=new THREE.Mesh(s,o);return n.position.set(t,e,i),n.r=25e-5*(4*Math.random()-2),n}init(){const t=new THREE.Group;t.position.set(0,0,0);let{points:e,spacing:i}=this.options;const s=e*e*2;this.linePositions=new Float32Array(s*s*3),this.lineColors=new Float32Array(s*s*3);const o=new THREE.BufferGeometry;o.setAttribute("position",new THREE.BufferAttribute(this.linePositions,3)),o.setAttribute("color",new THREE.BufferAttribute(this.lineColors,3)),o.computeBoundingSphere(),o.setDrawRange(0,0);const n=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,transparent:!0,alphaTest:.1,opacity:.2});this.linesMesh=new THREE.LineSegments(o,n),this.linesMesh.renderOrder=2,t.add(this.linesMesh);for(let s=0;s<=e;s++)for(let o=0;o<=e;o++){const n=ri(-3,3),r=(s-e/2)*i+ri(-5,5);let h=(o-e/2)*i+ri(-5,5);s%2&&(h+=.5*i);const l=this.genPoint(r,n-ri(5,15),h),a=this.genPoint(r+ri(-5,5),n+ri(5,15),h+ri(-5,5));t.add(l,a),this.points.push(l,a)}const r=new THREE.AmbientLight(16777215,.75);this.camera=new THREE.PerspectiveCamera(25,this.el.offsetWidth/this.el.offsetHeight,.01,1e4),this.camera.position.set(50,100,150),this.camera.lookAt(0,0,0),this.scene=new THREE.Scene,this.scene.add(this.camera),this.scene.add(r),this.scene.add(t)}onUpdate(){let t,e,i,s,o,n,r=0,h=0,l=0,a=0;for(let u=0;u<this.points.length;u++){s=this.points[u],this.rayCaster&&(this.mouse.updated?(e=.25*(12-this.rayCaster.ray.distanceToPoint(s.position)))>1?(a=1,s.material.color=this.highlightColor):(a=0,s.material.color=this.options.color):s.material.color!==this.options.color&&(s.material.color=this.options.color)),0!==s.r&&(n=Math.atan2(s.position.z,s.position.x)+s.r,t=Math.sqrt(s.position.z**2+s.position.x**2),s.position.x=t*Math.cos(n),s.position.z=t*Math.sin(n));for(let e=u;e<this.points.length;e++)if(o=this.points[e],(t=Math.sqrt((s.position.x-o.position.x)**2+(s.position.y-o.position.y)**2+(s.position.z-o.position.z)**2))<this.options.maxDistance){if(a)i=this.highlightColor;else{let e=1-t/this.options.maxDistance;e<0?e=0:e>1&&(e=1),i=this.options.backgroundColor.clone().lerp(this.options.color,e)}this.linePositions[r++]=s.position.x,this.linePositions[r++]=s.position.y,this.linePositions[r++]=s.position.z,this.linePositions[r++]=o.position.x,this.linePositions[r++]=o.position.y,this.linePositions[r++]=o.position.z,this.lineColors[h++]=i.r,this.lineColors[h++]=i.g,this.lineColors[h++]=i.b,this.lineColors[h++]=i.r,this.lineColors[h++]=i.g,this.lineColors[h++]=i.b,l++}}this.linesMesh.geometry.setDrawRange(0,2*l),this.linesMesh.geometry.attributes.position.needsUpdate=!0,this.linesMesh.geometry.attributes.color.needsUpdate=!0}}export default Viz;